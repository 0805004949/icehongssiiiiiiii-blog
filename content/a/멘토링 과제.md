---
title: ë©˜í† ë§ ê³¼ì œ
date: 2023-05-24T14:11:08
lastmod: 2023-06-05T14:34:42
tags: ["2023-k8s-bootcamp","k8s","KR","ì¸ê°•-devopsë¥¼ìœ„í•œ-k8s","blog-published"] 
categories: ["TIL"] # <!--"progress-diary", "posts"  , "TIL"í•˜ë‚˜ë§Œ ì„ íƒí•´ì„œë³´ì…ˆ -->
slug: "" # <!--ì˜ì–´ slugë§Œ ê°€ëŠ¥ urlì—ì„œ ë³´ì¼ ìˆ˜ ìˆìŒ-->
aliases: "" # <!--ë­”ì§€ëª°ë¼-->
keywords: [""] # <!--ë­”ì§€ëª°ë¼-->
series: "" # <!--ë­”ì§€ëª°ë¼-->
description: "" # <!--í¬ìŠ¤íŠ¸ì—ëŒ€í•œì„¤ëª… -->


---


ë§ˆìŠ¤í„°ë…¸ë“œì—ëŠ”Â ì›ë˜Â ìŠ¤ì¼€ì¤„ëŸ¬ê°€Â íŒŒë“œë¥¼Â ë°°ì¹˜Â ì•ˆÂ í•˜ëŠ”ë°  
ê·¸ê²ŒÂ ë§ˆìŠ¤í„°ë…¸ë“œì—Â í…Œì¸íŠ¸ê°€Â ì§€ì •ë˜ì–´Â ìˆì–´ì„œÂ ê·¸ë˜ìš”.  
ë§ˆìŠ¤í„°ë…¸ë“œÂ í•œëŒ€ë¡œÂ k8sÂ ìš´ì˜Â ëª©ì ì´ë‹ˆÂ ë§ˆìŠ¤í„°ë…¸ë“œì˜Â í…Œì¸íŠ¸ë¥¼Â í•´ì œí•´ì•¼í•´ìš”!

![](https://i.imgur.com/FWriByz.png)


![](https://i.imgur.com/qUdm0lY.png)

![](https://i.imgur.com/btjrwiC.png)
![](https://i.imgur.com/HSaUJmz.png)


![](https://i.imgur.com/vMIiKGu.png)

![](https://i.imgur.com/9HKUFwF.png)
![](https://i.imgur.com/Cwq4bmO.png)


## ec2ì— k8s í´ëŸ¬ìŠ¤í„° ì„¤ì¹˜ 

ë””í´íŠ¸ VPC ì—ì„œ EC2ì— K8S ì„¤ì¹˜í•˜ê³  ë§ˆìŠ¤í„° ë…¸ë“œ init
- ì™¸ë¶€ì ‘ê·¼ EIP
- swap disabled, 2 CPU, 2GB > RAM, linux(Redhat, Ubuntu)
- swap off

```
sudo swapoff -a # í˜„ì¬ ì‹œìŠ¤í…œì— ì ìš©(ë¦¬ë¶€íŒ…í•˜ë©´ ì¬ì„¤ì • í•„ìš”) 
sudo sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab # ë¦¬ë¶€íŒ… í•„ìˆ˜
```
- containerDì„¤ì¹˜ 

```
# Using Docker Repository
sudo apt update
sudo apt install -y ca-certificates curl gnupg lsb-release
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list

# containerd ì„¤ì¹˜
sudo apt update
sudo apt install -y containerd.io
# sudo systemctl status containerd # Ctrl + Cë¥¼ ëˆŒëŸ¬ì„œ ë‚˜ê°„ë‹¤.

# Containerd configuration for Kubernetes
cat <<EOF | sudo tee -a /etc/containerd/config.toml
[plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
[plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options]
SystemdCgroup = true
EOF

sudo sed -i 's/^disabled_plugins \=/\#disabled_plugins \=/g' /etc/containerd/config.toml
sudo systemctl restart containerd

# ì†Œì¼“ì´ ìˆëŠ”ì§€ í™•ì¸í•œë‹¤.
ls /var/run/containerd/containerd.sock

```

- kubeadm, kubectl, kublet ì„¤ì¹˜


```
cat <<EOF > kube_install.sh
# 1. apt íŒ¨í‚¤ì§€ ìƒ‰ì¸ì„ ì—…ë°ì´íŠ¸í•˜ê³ , ì¿ ë²„ë„¤í‹°ìŠ¤ apt ë¦¬í¬ì§€í„°ë¦¬ë¥¼ ì‚¬ìš©í•˜ëŠ” ë° í•„ìš”í•œ íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•œë‹¤.
sudo apt-get update
sudo apt-get install -y apt-transport-https ca-certificates curl

# 2. êµ¬ê¸€ í´ë¼ìš°ë“œì˜ ê³µê°œ ì‚¬ì´ë‹ í‚¤ë¥¼ ë‹¤ìš´ë¡œë“œ í•œë‹¤.
sudo curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://dl.k8s.io/apt/doc/apt-key.gpg
echo "deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main" | sudo tee /etc/apt/sources.list.d/kubernetes.list
sudo apt-get update -y

# 3. ì¿ ë²„ë„¤í‹°ìŠ¤ apt ë¦¬í¬ì§€í„°ë¦¬ë¥¼ ì¶”ê°€í•œë‹¤.
echo "deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main" | sudo tee /etc/apt/sources.list.d/kubernetes.list

# 4. apt íŒ¨í‚¤ì§€ ìƒ‰ì¸ì„ ì—…ë°ì´íŠ¸í•˜ê³ , kubelet, kubeadm, kubectlì„ ì„¤ì¹˜í•˜ê³  í•´ë‹¹ ë²„ì „ì„ ê³ ì •í•œë‹¤.
sudo apt-get update
sudo apt-get install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl
EOF

sudo bash kube_install.sh


```

- ë„·í•„í„° off
```
sudo -i (ì‰˜ì ‘ì†)
modprobe br_netfilter 
echo 1 > /proc/sys/net/ipv4/ip_forward 
echo 1 > /proc/sys/net/bridge/bridge-nf-call-iptables 
exit(ì‰˜ë‚˜ê°€ê¸°)
```

- ë§ˆìŠ¤í„°ë…¸ë“œ init
```
sudo kubeadm init
```

- cilium 
```
$ curl -LO https://github.com/cilium/cilium-cli/releases/latest/download/cilium-linux-amd64.tar.gz 

$ sudo tar xzvfC cilium-linux-amd64.tar.gz /usr/local/bin 
$ rm cilium-linux-amd64.tar.gz 

$ cilium install


```


----

## ec2 ì„¤ì¹˜ë„


```

apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: jenkins
spec:
  serviceName: jenkins
  replicas: 1
  selector:
    matchLabels:
      app: jenkins
  template:
    metadata:
      labels:
        app: jenkins
    spec:
      serviceAccountName: jenkins
      containers:
      - name: jenkins
        image: jenkins/jenkins:lts
        ports:
          - name: http-port
            containerPort: 8080
          - name: jnlp-port
            containerPort: 50000
        volumeMounts:
          - name: jenkins-vol
            mountPath: /var/jenkins_home
      volumes:
        - name: jenkins-vol
          hostPath:
            path: /jenkins-data
            type: Directory
---
apiVersion: v1
kind: Service
metadata:
  name: jenkins
spec:
  type: NodePort
  ports:
    - port: 8080
      targetPort: 8080
  selector:
    app: jenkins
---
apiVersion: v1
kind: Service
metadata:
  name: jenkins-jnlp
spec:
  type: ClusterIP
  ports:
    - port: 50000
      targetPort: 50000
  selector:
    app: jenkins
```



## 8080 í¬íŠ¸ ë§ˆìŠ¤í„°ë…¸ë“œ

roup list: Get "http://localhost:8080/api?timeout=32s": dial tcp 127.0.0.1:8080: connect: connection refused
E0601 09:39:40.060152    5305 memcache.go:265] couldn't get current server API group list: Get "http://localhost:8080/api?timeout=32s": dial tcp 127.0.0.1:8080: connect: connection refused
E0601 09:39:40.062001    5305 memcache.go:265] couldn't get current server API group list: Get "http://localhost:8080/api?timeout=32s": dial tcp 127.0.0.1:8080: connect: connection refused
E0601 09:39:40.063621    5305 memcache.go:265] couldn't get current server API group list: Get "http://localhost:8080/api?timeout=32s": dial tcp 127.0.0.1:8080: connect: connection refused
E0601 09:39:40.065086    5305 memcache.go:265] couldn't get current server API group list: Get "http://localhost:8080/api?timeout=32s": dial tcp 127.0.0.1:8080: connect: connection refused
The connection to the serv

- sudo apt install containerd, docker
- 
- sudo kubeadm init

```
  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

```


ë§ˆìŠ¤í„°ë…¸ë“œ
```

  Warning  FailedScheduling  51s   default-scheduler  0/1 nodes are available: 1 node(s) had untolerated taint {node-role.kubernetes.io/control-plane: }. preemption: 0/1 nodes are available: 1 Preemption is not helpful for scheduling..

```

https://blog.naver.com/isc0304/222512321772



- í˜„ì¬ ë…¸ë“œì˜ í…Œì¸íŠ¸ ì¡°íšŒ
``
```
kubectl describe node ip-172-31-57-193 | grep Taints


 kubectl get node ip-172-31-57-193 -o yaml | grep -i taint -F5
```

- í…Œì¸íŠ¸ í•´ì œ

```
kubectl taint node ip-172-31-57-193 NoSchedule-

```null
kubectl taint node [ë…¸ë“œ_ì´ë¦„] [í…Œì¸íŠ¸_í‚¤]=[í…Œì¸íŠ¸_ê°’]:[í…Œì¸íŠ¸_íš¨ê³¼]

kubectl taint node  ip-172-31-57-193 
node.kubernetes.io/not-ready=



cilium 
```

![](https://i.imgur.com/rylEMns.png)

- kubectl get pod -A 
notready ìƒíƒœì¸ê±°ëŠ” -> cilium ë„¤íŠ¸ì›Œí¬ ì—°ê²°ë˜ëŠ” ëª¨ë“ˆë¡œ
cilium ëª…ë ¹ì–´ë§Œ ê¹”ë ¤ìˆëŠ”ìƒíƒœì„

ì‹¤ë¦¬ì›€ì„ ëª¨ë“ˆë¡œ ë„ìš°ê¸°




---

[Jenkins ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ë° ë¹Œë“œ í™˜ê²½ ì„¸íŒ…]  
[Argo CDì»¨í…Œì´ë„ˆ ì‹¤í–‰ ë° Item ì„¤ì •]  
[gitea ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ë° repo ì„¤ì •]  
[gitea repo ìƒì„±]  
[ë„ì»¤ ë ˆí¬ì§€í† ë¦¬ ìƒì„± ë° Dockerfile ì‘ì„±]  
[Jenkins Pipeline ì‘ì„±]  
[Jenkins Pipeline í…ŒìŠ¤íŠ¸]  
[WebHook ì„¤ì •]

-  k8s https://velog.io/@niyu/k8s-taint-toleration
https://velog.io/@_zero_/%EC%BF%A0%EB%B2%84%EB%84%A4%ED%8B%B0%EC%8A%A4-%ED%85%8C%EC%9D%B8%ED%8A%B8Taints%EC%99%80-%ED%86%A8%EB%9F%AC%EB%A0%88%EC%9D%B4%EC%85%98Tolerations-%EA%B0%9C%EB%85%90%EA%B3%BC-%EC%84%A4%EC%A0%95

## ğŸ“‘ Ref
- ì¸í”„ëŸ° - devopsë¥¼ ìœ„í•œ ì¿ ë²„ë„¤í‹°ìŠ¤
